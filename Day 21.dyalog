p←⊃⎕NGET 'Day 21.txt' 1
i a←∪¨,/⍉↑f←{'contains'(≢¨⍥⊆⊆⊢)'\w+'⎕S'&'⊢⍵}¨p
m←⍉⊃∧⌿{fi fa←⍵ ⋄ ~(1-⍨2×a∊fa)⌿⍉⍪~i∊fi}¨f

⍝ Part 1
≢(⊃,/⊃¨f)∩i/⍨~∨/r←{1@o⊢0@(⊃¨o←⍸⍵/⍨1-⍨2×1=+⌿⍵)⊢⍵}⍣≡m

⍝ Part 2
{⊃{⍺,',',⍵}/⊃¨⍵[⍋2⊃¨⍵]}r/⍥,i∘.(,⍥⊂)a
